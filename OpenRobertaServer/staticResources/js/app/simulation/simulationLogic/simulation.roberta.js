define(["require","exports","interpreter.constants","util.roberta","interpreter.interpreter","interpreter.robotSimBehaviour","message","jquery","huebee","blockly","nn.controller","simulation.scene","robot.base","./simulation.objects"],(function(e,t,n,r,o,i,s,a,c,l,u,p,h,d){Object.defineProperty(t,"__esModule",{value:!0}),t.SimulationRoberta=void 0;var f=function(){function e(){this.canceled=!0,this._breakpoints=[],this._debugMode=!1,this._dt=0,this._interpreterRunning=!1,this._interpreters=[],this._renderTime=5,this._renderUntil=[],this._scale=1,this._time=(new Date).getTime(),this.dist=0,this.globalID=0,this.numRobots=0,this.observers=[]}return Object.defineProperty(e,"Instance",{get:function(){return this._instance||(this._instance=new e,this._instance._selectionListener=new h.SelectionListener,this._instance.scene=new p.SimulationScene(this._instance),this._instance.initEvents()),this._instance},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"debugMode",{get:function(){return this._debugMode},set:function(e){this._debugMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastMousePosition",{get:function(){return this._lastMousePosition},set:function(e){this._lastMousePosition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldMousePosition",{get:function(){return this._oldMousePosition},set:function(e){this._oldMousePosition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectionListener",{get:function(){return this._selectionListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderUntil",{get:function(){return this._renderUntil},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"breakpoints",{get:function(){return this._breakpoints},set:function(e){this._breakpoints=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"interpreters",{get:function(){return this._interpreters},set:function(e){this._interpreters=e,this.numRobots=this._interpreters.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"time",{get:function(){return this._time},set:function(e){this._time=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderTime",{get:function(){return this._renderTime},set:function(e){this._renderTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dt",{get:function(){return this._dt},set:function(e){this._dt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},set:function(e){this._scale=e},enumerable:!1,configurable:!0}),e.prototype.isInterpreterRunning=function(){return this._interpreterRunning},Object.defineProperty(e.prototype,"interpreterRunning",{set:function(e){this._interpreterRunning=e},enumerable:!1,configurable:!0}),e.prototype.addMarker=function(e){this.scene.addMarker(e)},e.prototype.addColorArea=function(e){this.scene.addColorArea(e),this.enableChangeObjectButtons()},e.prototype.addObstacle=function(e){this.scene.addObstacle(e),this.enableChangeObjectButtons()},e.prototype.allInterpretersTerminated=function(){for(var e=0;e<this.interpreters.length;e++)if(!this.interpreters[e].isTerminated())return!1;return!0},e.prototype.callbackOnTermination=function(){this.allInterpretersTerminated()&&("function"==typeof this.callbackOnEnd&&this.callbackOnEnd(),console.log("END of Sim")),this.scene.robots.forEach((function(e){e.interpreter.isTerminated()&&e.mobile&&e.reset(),e.interpreter.updateNNView&&u.saveNN2Blockly(e.interpreter.neuralNetwork)}))},e.prototype.deleteAllColorArea=function(){this.scene.colorAreaList=[]},e.prototype.deleteAllObstacle=function(){this.scene.obstacleList=[]},e.prototype.deleteAllMarker=function(){this.scene.markerList=[]},e.prototype.deleteSelectedObject=function(){this.scene.deleteSelectedObject()},e.prototype.disableChangeObjectButtons=function(){a(".simChangeObject").removeClass("disabled").addClass("disabled")},e.prototype.enableChangeObjectButtons=function(){a(".simChangeObject").removeClass("disabled")},e.prototype.endDebugging=function(){null!==this.interpreters&&this.interpreters.forEach((function(e){e.setDebugMode(!1),e.breakpoints=[]})),l.getMainWorkspace().getAllBlocks().forEach((function(e){a(e.svgPath_).stop(!0,!0).removeAttr("style")})),this.breakpoints=[],this.debugMode=!1,this.updateBreakpointEvent()},e.prototype.exportConfigData=function(){return this.getConfigData()},e.prototype.getConfigData=function(){var e=this.scene.uCanvas.height,t=this.scene.uCanvas.width,n={};function r(n){if(n instanceof d.RectangleSimulationObject){if(n instanceof d.MarkerSimulationObject){var r=n.markerId;return{x:n.x/t,y:n.y/e,w:n.w/t,h:n.h/e,theta:n.theta,color:n.color,form:d.SimObjectShape.Rectangle,type:n.type,markerId:r}}return{x:n.x/t,y:n.y/e,w:n.w/t,h:n.h/e,theta:n.theta,color:n.color,form:d.SimObjectShape.Rectangle,type:n.type}}return n instanceof d.TriangleSimulationObject?{ax:n.ax/t,ay:n.ay/e,bx:n.bx/t,by:n.by/e,cx:n.cx/t,cy:n.cy/e,color:n.color,form:d.SimObjectShape.Triangle,type:n.type}:n instanceof d.CircleSimulationObject?{x:n.x/t,y:n.y/e,r:n.r/e/t,color:n.color,form:d.SimObjectShape.Circle,type:n.type}:void 0}var o=this.scene.getRobotPoses();return n.robotPoses=o.map((function(n){return[{x:n[0].x/t,y:n[0].y/e,theta:n[0].theta},{x:n[1].x/t,y:n[1].y/e,theta:n[1].theta}]})),n.obstacles=this.scene.obstacleList.map((function(e){return r(e)})),n.colorAreas=this.scene.colorAreaList.map((function(e){return r(e)})),n.marker=this.scene.markerList.map((function(e){return r(e)})),n},e.prototype.getNumRobots=function(){return this.interpreters.length},e.prototype.handleMouse=function(t){switch("mouseup"!==t.type&&"touchend"!==t.type&&t.stopPropagation(),t.preventDefault(),a("#robotLayer").data().hovered?a("#robotLayer").data("hovered",!1):a("#robotLayer").css("cursor","auto"),t&&"mouseout"!==t.type&&"touchcancel"!==t.type&&"touchend"!==t.type&&!t.startX&&(r.extendMouseEvent(t,this.scale,a("#robotLayer")),this.lastMousePosition={x:t.startX,y:t.startY}),t.type){case"mousedown":case"touchstart":this.oldMousePosition=this.lastMousePosition,this.selectionListener.fire(null);break;case"mousemove":case"touchmove":if(!this.oldMousePosition)return;t&&!t.startX&&r.extendMouseEvent(t,e.Instance.scale,a("#robotLayer"));var n=t,o=(n.startX-this.oldMousePosition.x)*this.scale,i=(n.startY-this.oldMousePosition.y)*this.scale,s=a("#canvasDiv").position();s.top+=i,s.left+=o,a("#canvasDiv").css({top:s.top}),a("#canvasDiv").css({left:s.left});break;default:this.oldMousePosition=null}},e.prototype.handleMouseWheel=function(e){var t=this.scale,n=0;if(void 0!==e.originalEvent.wheelDelta)n=e.originalEvent.wheelDelta;else if(e.originalEvent.touches){if(!e.originalEvent.touches[0]||!e.originalEvent.touches[1])return void(this.dist=0);var r=e.originalEvent.touches[0].pageX-e.originalEvent.touches[1].pageX,o=e.originalEvent.touches[0].pageY-e.originalEvent.touches[1].pageY,i=r*r+o*o;if(0==this.dist)return void(this.dist=i);n=i-this.dist,this.dist=i}else n=-e.originalEvent.deltaY;var s=!1;if(n>0?(this.scale*=1.025,this.scale>15&&(this.scale=15),s=!0):n<0&&(this.scale*=.925,this.scale<.25&&(this.scale=.25),s=!0),s){var c=this.scale-t,l=a("#canvasDiv").position(),u=this.scene.uCanvas.width*c,p=this.scene.uCanvas.height*c;l.top=l.top-p/2,l.left=l.left-u/2,a("#canvasDiv").css({top:l.top}),a("#canvasDiv").css({left:l.left}),this.scene.resetAllCanvas(!1)}return!1},e.prototype.importConfigData=function(){a("#backgroundFileSelector").val(null),a("#backgroundFileSelector").attr("accept",".json"),a("#backgroundFileSelector").off();var e=this;a("#backgroundFileSelector").onWrap("change",(function(t){var n=t.target.files[0],r=new FileReader;return r.onload=function(t){try{var n=JSON.parse(t.target.result);e.setNewConfig(n)}catch(e){console.error(e)}},r.readAsText(n),!1})),a("#backgroundFileSelector").clickWrap()},e.prototype.importImage=function(){var e=a("#backgroundFileSelector");e.val(null),e.attr("accept",".png, .jpg, .jpeg, .svg"),e.clickWrap();var t=this;e.on("change",(function(e){var n=e.target.files[0],o=new FileReader;return o.onload=function(){var e=new Image;e.onload=function(){var n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0);var o=n.toDataURL("image/png"),i=new Image(n.width,n.height);i.src=o,i.onload=function(){t.scene.customBackgroundLoaded?t.scene.imgBackgroundList[t.scene.imgBackgroundList.length-1]=i:t.scene.imgBackgroundList.push(i),t.setBackground(t.scene.imgBackgroundList.length-1)},r.isLocalStorageAvailable()&&(a("#show-message-confirm").oneWrap("shown.bs.modal",(function(){a("#confirm").off(),a("#confirm").on("click",(function(e){e.preventDefault(),localStorage.setItem("customBackground",JSON.stringify({image:o.replace(/^data:image\/(png|jpg);base64,/,""),timestamp:(new Date).getTime()}))})),a("#confirmCancel").off(),a("#confirmCancel").on("click",(function(e){e.preventDefault()}))})),s.displayPopupMessage("Blockly.Msg.POPUP_BACKGROUND_STORAGE",l.Msg.POPUP_BACKGROUND_STORAGE,l.Msg.YES,l.Msg.NO))},"string"==typeof o.result&&(e.src=o.result)},o.readAsDataURL(n),!1}))},e.prototype.init=function(e,t,n,r){var s=this;this.robotType=r||this.robotType,this.storedPrograms=e,this.resetRenderUntil(e.length);var a=[];this.interpreters=e.map((function(e){var t=JSON.parse(e.javaScriptProgram);return a.push(e.configuration),new o.Interpreter(t,new i.RobotSimBehaviour,s.callbackOnTermination.bind(s),s.breakpoints,e.programName,e.updateNNView)})),this.updateDebugMode(this.debugMode);var c=e.map((function(e){return e.programName}));this.scene.init(this.robotType,t,this.interpreters,a,c,n)},e.prototype.initColorPicker=function(e){var t=this;e&&e.length>0?this.colorpicker=new c("#colorpicker",{shades:1,hues:8,customColors:e,setText:!1}):this.colorpicker=new c("#colorpicker",{shades:1,hues:8,setText:!1}),this.colorpicker.on("change",(function(e){t.scene.changeColorWithColorPicker(e)}));var n=c.prototype.close;c.prototype.close=function(){a(".huebee__container").off("mouseup touchend",(function(e){e.stopPropagation(),t.resetColorpickerCursor()})),n.call(this)};var r=c.prototype.open;c.prototype.open=function(){r.call(this),a(".huebee__container").on("mouseup touchend",(function(e){t.resetColorpickerCursor()}))}},e.prototype.initEvents=function(){var e=this;a("#simDiv").on("wheel mousewheel touchmove",(function(t){e.handleMouseWheel(t)})),a("#canvasDiv").on("mousedown touchstart mousemove touchmove mouseup touchend mouseout touchcancel",(function(t){e.handleMouse(t)})),a("#robotLayer").on("click touchstart",(function(e){a("#robotLayer").attr("tabindex",0),a("#robotLayer").trigger("focus"),e.preventDefault()})),a("#blocklyDiv").on("click touchstart",(function(e){a("#blocklyDiv").trigger("focus"),e.preventDefault()}))},e.prototype.interpreterAddEvent=function(e){this.updateBreakpointEvent(),this.interpreters&&this.interpreters.forEach((function(t){return t.addEvent(e)}))},e.prototype.removeBreakPoint=function(e){for(var t=0;t<this._breakpoints.length;t++)this._breakpoints[t]===e.id&&this._breakpoints.splice(t,1);if(!this._breakpoints&&this._breakpoints.length>0&&null!==this.interpreters)for(t=0;t<this.interpreters.length;t++)this.interpreters[t].removeEvent(n.DEBUG_BREAKPOINT)},e.prototype.render=function(){var e=this;if(this.canceled)return cancelAnimationFrame(this.globalID),this.renderTime=5,void(this.globalID=0);this.globalID=requestAnimationFrame(this.render.bind(this));var t=(new Date).getTime(),n=t-this.time,r=Math.min(15,Math.abs(n-this.renderTime)/this.getNumRobots());this.dt=n/1e3,this.stepCounter+=1,this.isInterpreterRunning()&&this.interpreters.forEach((function(n,o){if(n.isTerminated())e.allInterpretersTerminated()&&(e.interpreterRunning=!1);else if(e.renderUntil[o]<=t){var i=n.run(t+r),s=(new Date).getTime();e.renderUntil[o]=s+i}}),this),this.updateBreakpointEvent();var o=(new Date).getTime();this.scene.update(this.dt,this.isInterpreterRunning()),this.renderTime=(new Date).getTime()-o,this.time=t},e.prototype.resetColorpickerCursor=function(){this.colorpicker.color=null,this.colorpicker.setTexts(),this.colorpicker.setBackgrounds(),this.colorpicker.cursor.classList.add("is-hidden")},e.prototype.resetPose=function(){this.scene.resetPoseAndDrawings()},e.prototype.resetRenderUntil=function(e){this._renderUntil=[];for(var t=0;t<e;t++)this._renderUntil[t]=0},e.prototype.run=function(e,t){this.callbackOnEnd=t;var n=this;this.init(e,!1,(function(){setTimeout((function(){n.interpreterRunning=!0}),250)}))},e.prototype.setBackground=function(e){this.scale=1,this.scene.stepBackground(e)},e.prototype.setNewConfig=function(e){var t=this.scene.uCanvas.height,n=this.scene.uCanvas.width,r=this;function o(e){var o={};switch(o.id=r.scene.uniqueObjectId,"MARKER"===e.type?(o.shape="MARKER",o.markerId=e.markerId):o.shape=e.form.toUpperCase(),o.color=e.color,o.newObjecttype=e.type,e.form.toLowerCase()){case"rectangle":o.p={x:e.x*n,y:e.y*t},o.params=[e.w*n,e.h*t];break;case"triangle":o.p={x:0,y:0},o.params=[e.ax*n,e.ay*t,e.bx*n,e.by*t,e.cx*n,e.cy*t];break;case"circle":o.p={x:e.x*n,y:e.y*t},o.params=[e.r*t*n]}return o}var i=[];e.robotPoses.forEach((function(e){if(Array.isArray(e)){(o={}).x=e[0].x*n,o.y=e[0].y*t,o.theta=e[0].theta;var r={};r.x=e[1].x*n,r.y=e[1].y*t,r.theta=e[1].theta,i.push([o,r])}else{var o;(o={}).x=e.x*n,o.y=e.y*t,o.theta=e.theta,i.push([o,o])}})),this.scene.setRobotPoses(i);var s=[];e.obstacles.forEach((function(e){s.push(o(e))})),this.scene.addImportObstacle(s);var a=[];e.colorAreas.forEach((function(e){a.push(o(e))})),this.scene.addImportColorAreaList(a);var c=[];e.marker&&e.marker.forEach((function(e){c.push(o(e))})),this.scene.addImportMarkerList(c)},e.prototype.setPause=function(e){this.interpreterRunning=!e},e.prototype.start=function(){this.canceled=!1,0===this.globalID&&this.render()},e.prototype.stop=function(){this.interpreters.forEach((function(e){e.updateNNView&&u.saveNN2Blockly(e.neuralNetwork)})),this.canceled=!0},e.prototype.stopProgram=function(){this.interpreters.forEach((function(e){e.removeHighlights(),e.terminate(),e.updateNNView&&u.saveNN2Blockly(e.neuralNetwork)})),this.interpreterRunning=!1},e.prototype.toggleColorPicker=function(){a(".huebee").length?this.colorpicker.close():this.colorpicker.open()},e.prototype.toggleTrail=function(){this.scene.toggleTrail()},e.prototype.updateBreakpointEvent=function(){var e=this;this.debugMode?l.getMainWorkspace().getAllBlocks().forEach((function(t){if(!a(t.svgGroup_).hasClass("blocklyDisabled")){e.observers.hasOwnProperty(t.id)&&e.observers[t.id].disconnect();var n=new MutationObserver((function(n){n.forEach((function(n){a(t.svgGroup_).hasClass("blocklyDisabled")?(e.removeBreakPoint(t),a(t.svgPath_).removeClass("breakpoint").removeClass("selectedBreakpoint")):a(t.svgGroup_).hasClass("blocklySelected")&&(a(t.svgPath_).hasClass("breakpoint")?(e.removeBreakPoint(t),a(t.svgPath_).removeClass("breakpoint")):a(t.svgPath_).hasClass("selectedBreakpoint")?(e.removeBreakPoint(t),a(t.svgPath_).removeClass("selectedBreakpoint").stop(!0,!0).animate({"fill-opacity":"1"},0)):(e._breakpoints.push(t.id),a(t.svgPath_).addClass("breakpoint")))}))}));e.observers[t.id]=n,n.observe(t.svgGroup_,{attributes:!0})}}),e):l.getMainWorkspace().getAllBlocks().forEach((function(t){e.observers.hasOwnProperty(t.id)&&e.observers[t.id].disconnect(),a(t.svgPath_).removeClass("breakpoint")}),e)},e.prototype.updateDebugMode=function(e){if(this.debugMode=e,null!==this.interpreters)for(var t=0;t<this.interpreters.length;t++)this.interpreters[t].setDebugMode(e);this.updateBreakpointEvent()},e}();t.SimulationRoberta=f,function(){for(var e=["webkit","moz","ms","o"],t=null,n=0;n<e.length&&!window.requestAnimationFrame&&!window.cancelAnimationFrame;n++)t=e[n],window.requestAnimationFrame=window.requestAnimationFrame||window[t+"RequestAnimationFrame"],window.cancelAnimationFrame=window.cancelAnimationFrame||window[t+"CancelAnimationFrame"]||window[t+"CancelRequestAnimationFrame"];if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e,t){var n=window.performance.now(),o=Math.max(r+16,n);return setTimeout((function(){e(r=o)}),o-n)},window.cancelAnimationFrame=clearTimeout}}(),t.default=f.Instance}));
//# sourceMappingURL=simulation.roberta.js.map
//# sourceMappingURL=simulation.roberta.js.map
