define(["require","exports","util.roberta","log","message","program.controller","program.model","socket.controller","thymioSocket.controller","guiState.controller","webview.controller","jquery","blockly","guiState.model","webUsb.controller"],(function(e,t,o,n,a,r,i,s,d,l,c,m,g,u,p){var f,C,b;function P(e){var t,o;l.setPing(!1),l.setConnectionState("busy"),n.info("run "+l.getProgramName()+"on brick"),e?o=e:(t=g.Xml.workspaceToDom(f),o=g.Xml.domToText(t));var a=!l.isConfigurationStandard()&&!l.isConfigurationAnonymous()?l.getConfigurationName():void 0,s=l.isConfigurationAnonymous()?l.getConfigurationXML():void 0,d=function(){var e=l.getConnectionTypeEnum();if(l.getConnection()===e.AUTO||l.getConnection()===e.LOCAL)return function(e){w(e),r.reloadProgram(e),l.setPing(!0)};if(l.getConnection()===e.AGENT||l.getConnection()===e.AGENTORTOKEN&&l.getIsAgent())return function(e){T(e),r.reloadProgram(e),l.setPing(!0)};if(l.getConnection()===e.TDM)return function(e){O(e),r.reloadProgram(e),l.setPing(!0)};if(l.getConnection()===e.WEBVIEW)return function(e){N(e),r.reloadProgram(e),l.setPing(!0)};if(l.getConnection()===e.JSPLAY)return function(e){h(e),r.reloadProgram(e),l.setPing(!0)};return function(e){S(e),r.reloadProgram(e),l.setPing(!0)}}();l.getConnection()===l.getConnectionTypeEnum().TDM?i.showSourceProgram(l.getProgramName(),a,o,s,r.SSID,r.password,l.getLanguage(),d):i.runOnBrick(l.getProgramName(),a,o,s,r.SSID,r.password,l.getLanguage(),d)}function w(e){if(l.setState(e),"ok"==e.rc){var t=!1;if(o.isWebUsbSupported()&&l.getVendor()&&"na"!==l.getVendor()){t=!0;var n=m("#popupDownloadHeader").text();m("#popupDownloadHeader").text(n.replace("$",m.trim(l.getRobotRealName()))),m("#programHint").addClass("hidden"),m("#changedDownloadFolder").addClass("hidden"),m("#OKButtonModalFooter").addClass("hidden"),p.isWebUsbSelected()?y(e):(m("#downloadType").removeClass("hidden"),m("#webUsb").oneWrap("click",(function(t){p.setIsWebUsbSelected(!0),y(e)})),m("#fileDownload").oneWrap("click",(function(t){m("#downloadType").addClass("hidden"),m("#programHint").removeClass("hidden"),m("#changedDownloadFolder").removeClass("hidden"),m("#OKButtonModalFooter").removeClass("hidden"),v(e)})))}else v(e);if(t=t||!(l.isProgramToDownload()||null!==navigator.userAgent.toLowerCase().match(/iPad|iPhone|android/i)||l.getConnection()==l.getConnectionTypeEnum().LOCAL)){n=m("#popupDownloadHeader").text();m("#popupDownloadHeader").text(n.replace("$",m.trim(l.getRobotRealName()))),m("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(e){var t=m("#popupDownloadHeader").text();m("#popupDownloadHeader").text(t.replace(m.trim(l.getRobotRealName()),"$")),m("#label-checkbox").is(":checked")&&l.setProgramToDownload(),m("#programLink").remove(),m("#download-instructions").empty(),m("#programHint").removeClass("hidden"),m("#changedDownloadFolder").removeClass("hidden"),m("#OKButtonModalFooter").removeClass("hidden"),m("#downloadType").addClass("hidden"),m("#status").addClass("hidden"),m("#progressBar").width("0%"),m("#transfer").text("0%"),m("#webUsb").off("click"),m("#fileDownload").off("click"),l.setConnectionState("wait")})),m("#save-client-compiled-program").modal("show")}}else l.setConnectionState("wait"),a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot())}function y(e){m("#downloadType").addClass("hidden"),m("#status").removeClass("hidden"),p.connect(l.getVendor(),e.compiledCode).then((function(t){"done"==t?a.displayInformation(e,"MESSAGE_EDIT_START",e.message,l.getProgramName(),l.getRobot()):"disconnected"==t?setTimeout((function(){y(e)}),100):"flashing"==t||m("#save-client-compiled-program").modal("hide"),l.setConnectionState("wait"),u.robot.state="wait"}))}function v(e){var t=(e.programName||l.getProgramName())+"."+l.getBinaryFileExtension();if("bin"!==l.getBinaryFileExtension()&&"uf2"!==l.getBinaryFileExtension()||(e.compiledCode=o.base64decode(e.compiledCode)),l.isProgramToDownload()||null!==navigator.userAgent.toLowerCase().match(/iPad|iPhone|android/i))o.download(t,e.compiledCode),setTimeout((function(){l.setConnectionState("wait")}),5e3),a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot());else if(l.getConnection()==l.getConnectionTypeEnum().LOCAL)setTimeout((function(){l.setConnectionState("wait")}),5e3),a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot());else{D(t,e.compiledCode);for(var n=1;g.Msg["POPUP_DOWNLOAD_STEP_"+n];n++){var r=m('<li class="typcn typcn-roberta">'),i=g.Msg["POPUP_DOWNLOAD_STEP_"+n+"_"+l.getRobotGroup().toUpperCase()]||g.Msg["POPUP_DOWNLOAD_STEP_"+n]||"POPUP_DOWNLOAD_STEP_"+n;r.html('<span class="download-message">'+i+"</span>"),r.css("opacity","0"),m("#download-instructions").append(r)}var s=l.getRobotGroup().toUpperCase();m("#download-instructions li").each((function(e){"calliope"===l.getRobotGroup()&&(s="MINI"),m(this).html(m(this).html().replace("$",s))})),m("#download-instructions li").each((function(e){m(this).delay(750*e).animate({opacity:1},1e3)}))}}function h(e){if("ok"!==e.rc)l.setConnectionState("wait"),a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot());else{var t,n=o.base64decode(e.compiledCode);if(m("#changedDownloadFolder").addClass("hidden"),window.msCrypto)D(l.getProgramName()+".wav",n);else{m("#OKButtonModalFooter").addClass("hidden");var r=new Blob([n],{type:"audio/wav"});(function(e){var t;if(m("#trA").removeClass("hidden"),"Blob"in window){(t=document.createElement("button")).setAttribute("type","button"),t.setAttribute("class","btn btn-primary");var o=!1;t.onclick=function(){0==o?(e.play(),n.setAttribute("class","typcn typcn-media-stop"),o=!0,e.addEventListener("ended",(function(){m("#save-client-compiled-program").modal("hide")}))):(n.setAttribute("class","typcn typcn-media-play"),e.pause(),e.load(),o=!1)};var n=document.createElement("span");n.setAttribute("class","typcn typcn-media-play"),n.setAttribute("style","color : black"),t.appendChild(n)}if(t){var a=document.createElement("div");a.setAttribute("id","programLink"),a.setAttribute("style","text-align: center;"),a.appendChild(document.createElement("br")),a.appendChild(t),t.setAttribute("style","font-size:36px"),m("#downloadLink").append(a)}})(t=new Audio(window.URL.createObjectURL(r)))}var i=m("#popupDownloadHeader").text();m("#popupDownloadHeader").text(i.replace("$",m.trim(l.getRobotRealName())));for(var s=1;g.Msg["POPUP_DOWNLOAD_STEP_"+s];s++){var d=m('<li class="typcn typcn-roberta">'),c=g.Msg["POPUP_DOWNLOAD_STEP_"+s+"_"+l.getRobotGroup().toUpperCase()]||g.Msg["POPUP_DOWNLOAD_STEP_"+s]||"POPUP_DOWNLOAD_STEP_"+s;d.html('<span class="download-message">'+c+"</span>"),d.css("opacity","0"),m("#download-instructions").append(d)}m("#save-client-compiled-program").oneWrap("shown.bs.modal",(function(e){m("#download-instructions li").each((function(e){m(this).delay(750*e).animate({opacity:1},1e3)}))})),m("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(o){window.msCrypto||(t.pause(),t.load());var n=m("#popupDownloadHeader").text();m("#popupDownloadHeader").text(n.replace(m.trim(l.getRobotRealName()),"$")),m("#programLink").remove(),m("#download-instructions").empty(),l.setConnectionState("wait"),a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot()),m("#changedDownloadFolder").removeClass("hidden"),m("#OKButtonModalFooter").removeClass("hidden")})),m("#save-client-compiled-program").modal("show")}}function T(e){m("#menuRunProg").parent().addClass("disabled"),m("#head-navi-icon-robot").addClass("busy"),l.setState(e),"ok"==e.rc?(s.uploadProgram(e.compiledCode,l.getRobotPort()),setTimeout((function(){l.setConnectionState("error")}),5e3)):l.setConnectionState("error"),a.displayInformation(e,e.message,e.message,l.getProgramName())}function O(e){m("#menuRunProg").parent().addClass("disabled"),l.setConnectionState("busy"),u.robot.state="busy",l.setState(e),"ok"==e.rc?(d.uploadProgram(e.sourceCode).then((function(t){"done"==t&&a.displayInformation(e,"MESSAGE_EDIT_START",e.message,l.getProgramName(),l.getRobot())}),(function(e){a.displayInformation({rc:"error"},null,e,l.getProgramName(),l.getRobot())})),setTimeout((function(){l.setConnectionState("wait"),u.robot.state="wait"}),1e3)):(l.setConnectionState("wait"),u.robot.state="wait",a.displayInformation(e,e.message,e.message,l.getProgramName(),l.getRobot()))}function S(e){l.setState(e),a.displayInformation(e,e.message,e.message,e.programName||l.getProgramName(),l.getRobot()),"ok"==e.rc?g.Msg["MENU_ROBOT_STOP_HINT_"+l.getRobotGroup().toUpperCase()]&&a.displayMessage("MENU_ROBOT_STOP_HINT_"+l.getRobotGroup().toUpperCase(),"TOAST"):l.setConnectionState("error")}function N(e){if(a.displayInformation(e,e.message,e.message,l.getProgramName()),"ok"===e.rc){var t=e.compiledCode,o=JSON.parse(t);if(null!==(C=c.getInterpreter(o))){l.setConnectionState("busy"),f.robControls.switchToStop();try{A()}catch(e){C.terminate(),C=null,alert(e)}}}}function A(){if(!C.isTerminated()&&!b){var e=(new Date).getTime()+100;E(A,Math.max(100,C.run(e)))}}function E(e,t){t>100?(t-=100,setTimeout(E,100,e,t)):setTimeout(e,t)}function D(e,t){var n;if("msSaveOrOpenBlob"in navigator?(m("#trA").addClass("hidden"),o.download(e,t),l.setConnectionState("error")):m("#trA").removeClass("hidden"),"Blob"in window){var a=new Blob([t],{type:"application/octet-stream"});"msSaveOrOpenBlob"in navigator?navigator.msSaveOrOpenBlob(a,e):((n=document.createElement("a")).download=e,n.innerHTML=e,n.href=window.URL.createObjectURL(a))}else(n=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none";if(n&&!("msSaveOrOpenBlob"in navigator)){var r=document.createElement("div");r.setAttribute("id","programLink");var i=document.createElement("br");r.setAttribute("style","text-align: center;"),r.appendChild(i),r.appendChild(n),n.setAttribute("style","font-size:36px"),m("#downloadLink").append(r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.reset2DefaultFirmware=t.runOnBrick=t.runNative=t.init=void 0,t.init=function(e){f=l.getBlocklyWorkspace(),b=!1,g.bindEvent_(f.robControls.runOnBrick,"mousedown",null,(function(e){if(m("#runOnBrick").hasClass("disabled")){var t=m("#releaseInfo"),o=t.children("#releaseInfoTitle");t.children("#releaseInfoContent").html(g.Msg.POPUP_RUN_NOTIFICATION),o.html(g.Msg.POPUP_ATTENTION);var a=t.on("notificationFadeInComplete",(function(){clearTimeout(a.data("hideInteval"));var e=setTimeout((function(){t.fadeOut(500)}),1e4);a.data("hideInteval",e)}));return t.fadeIn(500,(function(){m(this).trigger("notificationFadeInComplete")})),!1}return n.info("runOnBrick from blockly button"),P(),!1})),g.bindEvent_(f.robControls.stopBrick,"mousedown",null,(function(e){return n.info("stopBrick from blockly button"),null!==C&&C.terminate(),!1})),g.bindEvent_(f.robControls.stopProgram,"mousedown",null,(function(e){return n.info("stopProgram from blockly button"),l.getConnection()==l.getConnectionTypeEnum().TOKEN?i.stopProgram((function(){l.setState(result),a.displayInformation(result,result.message,result.message,l.getProgramName(),l.getRobot()),"ok"!=result.rc&&l.setConnectionState("error")})):"thymio"==l.getRobotGroup()&&d.stopProgram().then((function(e){"done"==e&&a.displayInformation(result,"MESSAGE_EDIT_START",result.message,l.getProgramName(),l.getRobot())}),(function(e){a.displayInformation({rc:"error"},null,e,l.getProgramName(),l.getRobot())})),!1})),"autoConnection"!==l.getConnection()&&"jsPlay"!==l.getConnection()&&l.setRunEnabled(!1)},t.runNative=function(e){l.setPing(!1),l.setConnectionState("busy"),n.info("run "+l.getProgramName()+"on brick from source code editor");var t=function(){var e=l.getConnectionTypeEnum();if(l.getConnection()===e.AUTO||l.getConnection()===e.LOCAL)return function(e){w(e)};if(l.getConnection()===e.AGENT||l.getConnection()===e.AGENTORTOKEN&&l.getIsAgent())return function(e){T(e)};if(l.getConnection()===e.TDM)return function(e){O(e)};if(l.getConnection()===e.WEBVIEW)return function(e){N(e)};if(l.getConnection()===e.JSPLAY)return function(e){h(e)};return function(e){S(e)}}();i.runNative(l.getProgramName(),e,l.getLanguage(),(function(e){t(e),l.setPing(!0)}))},t.runOnBrick=P,t.reset2DefaultFirmware=function(){if(l.hasRobotDefaultFirmware()){var e=l.getConnectionTypeEnum();l.getConnection()==e.AUTO||l.getConnection()==e.LOCAL?i.resetProgram((function(e){w(e)})):l.getConnection()==e.AGENTORTOKEN?i.resetProgram((function(e){T(e)})):i.resetProgram((function(e){S(e)}))}else a.displayInformation({rc:"error"},"","should not happen!")}}));
//# sourceMappingURL=progRun.controller.js.map
//# sourceMappingURL=progRun.controller.js.map
