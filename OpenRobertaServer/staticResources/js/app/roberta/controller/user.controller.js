define(["require","exports","message","util.roberta","user.model","guiState.controller","jquery","blockly"],(function(e,s,r,o,a,n,i,t){var l,u,g,d,c,m,f,A,p,F,I,v,_;Object.defineProperty(s,"__esModule",{value:!0}),s.initValidationMessages=s.showResetPassword=s.showUserInfo=s.showDeleteUserModal=s.showUserGroupLoginForm=s.showLoginForm=s.showUserDataForm=s.init=s.logout=s.activateAccount=void 0;var D=300,E=150;function h(){u.validate(),u.valid()&&a.login(i("#loginAccountName").val(),i("#loginPassword").val(),(function(e){"ok"===e.rc&&(n.setLogin(e),1===e.userId&&i("#menuNotificationWrap").removeClass("hidden")),r.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,n.getUserName())}))}function L(){a.logout((function(e){o.response(e),"ok"===e.rc&&(n.isUserMemberOfUserGroup()&&i("#menuDeleteUser, #menuGroupPanel").parent().removeClass("unavailable"),n.setLogout()),r.displayInformation(e,"MESSAGE_USER_LOGOUT",e.message,n.getUserName())}))}function N(){m.validate(),m.valid()&&a.deleteUserOnServer(n.getUserAccountName(),i("#singleModalInput").val(),(function(e){"ok"===e.rc&&L(),r.displayInformation(e,e.message,e.message,n.getUserAccountName())}))}function U(){u.removeData("validator"),i.validator.addMethod("loginRegex",(function(e,s){return this.optional(s)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field contains nonvalid symbols."),u.validate({rules:{loginAccountName:{required:!0,loginRegex:!0},loginPassword:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},messages:{loginAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},loginPassword:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function w(){d.removeData("validator"),i.validator.addMethod("emailRegex",(function(e,s){return this.optional(s)||/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i.test(e)}),"This field must contain a valid email adress."),i.validator.addMethod("loginRegex",(function(e,s){return this.optional(s)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field must contain only letters, numbers, or dashes."),d.validate({rules:{registerAccountName:{required:!0,maxlength:25,loginRegex:!0},registerPass:{required:!0,minlength:6},registerPassConfirm:{required:!0,equalTo:"#registerPass"},registerUserName:{required:!1,maxlength:25,loginRegex:!0},registerUserEmail:{required:!1,emailRegex:!0},registerUserAge:{required:function(e){return""!=i("#registerUserEmail").val()}}},onfocusout:!1,errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},showErrors:function(e,s){if(s.length){var r=s.shift();this.errorList=[r]}this.defaultShowErrors()},messages:{registerAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,maxlength:t.Msg.VALIDATION_MAX_LENGTH,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},registerPass:{required:t.Msg.VALIDATION_FIELD_REQUIRED,minlength:t.Msg.VALIDATION_PASSWORD_MIN_LENGTH},registerPassConfirm:{required:t.Msg.VALIDATION_FIELD_REQUIRED,equalTo:t.Msg.VALIDATION_SECOND_PASSWORD_EQUAL},registerUserName:{required:jQuery.validator.format(t.Msg.VALIDATION_FIELD_REQUIRED),maxlength:t.Msg.VALIDATION_MAX_LENGTH,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},registerUserEmail:{required:t.Msg.VALIDATION_FIELD_REQUIRED,emailRegex:t.Msg.VALIDATION_VALID_EMAIL_ADDRESS},registerUserAge:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function R(){g.removeData("validator"),g.validate({rules:{lost_email:{required:!0,email:!0}},errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},messages:{lost_email:{required:t.Msg.VALIDATION_FIELD_REQUIRED,email:t.Msg.VALIDATION_VALID_EMAIL_ADDRESS}}})}function O(e,s){e.fadeToggle(D,(function(){s.fadeToggle()}))}function P(e,s){e.addClass("hidden"),s.removeClass("hidden")}function C(){d.off("submit"),d.onWrap("submit",(function(e){e.preventDefault(),d.validate(),d.valid()&&a.createUserToServer(i("#registerAccountName").val(),i("#registerUserName").val(),i("#registerUserEmail").val(),i("#registerPass").val(),i("#registerUserAge").val(),n.getLanguage(),(function(e){"ok"===e.rc&&(i("#loginAccountName").val(i("#registerAccountName").val()),i("#loginPassword").val(i("#registerPass").val()),h()),r.displayInformation(e,e.message,e.message,i("#registerAccountName").val())}))}),"submit registration data"),i("#registerUser").text(t.Msg.POPUP_REGISTER_USER),i("#registerAccountName").prop("disabled",!1),i("#userInfoLabel").addClass("hidden"),n.isPublicServerVersion()||i("#fgUserAge").addClass("hidden"),i("#fgRegisterPass").show(),i("#fgRegisterPassConfirm").show(),i("#showChangeUserPassword").addClass("hidden"),i("#resendActivation").addClass("hidden"),i("#register_login_btn").show(),i("#register_lost_btn").show()}function M(){i("#login-user").onWrap("hidden.bs.modal",(function(){u.validate().resetForm(),g.validate().resetForm(),d.validate().resetForm(),i("#register-form .hint").hide(),l.find("input").val(""),i("#registerUserAge").val("none")})),g.onWrap("submit",(function(e){e.preventDefault(),g.validate(),g.valid()&&a.userPasswordRecovery(i("#lost_email").val(),n.getLanguage(),(function(e){r.displayInformation(e,e.message,e.message)}))}),"submit password recovery data"),u.onWrap("submit",(function(e){e.preventDefault(),h()}),"submit login data"),i("#register-form input.form-control, #register-form select.form-control").focus((function(e){var s=i(this).parent().next(".hint");i("#register-form .hint").not(s).slideUp(E),s.slideDown(E)})),i("#registerUserEmail").on("change paste keyup",(function(){""==i("#registerUserEmail").val()?i("#fgUserAge").fadeOut():i("#fgUserAge").fadeIn()})),i("#login_register_btn").onWrap("click",(function(){C(),P(f,A),O(u,d),o.setFocusOnElement(i("#registerAccountName"))}),"login_register_btn"),i("#register_login_btn").onWrap("click",(function(){P(A,f),O(d,u),o.setFocusOnElement(i("#loginAccountName"))}),"register_login_btn"),i("#login_lost_btn").onWrap("click",(function(){P(f,p),O(u,g),o.setFocusOnElement(i("#lost_email"))}),"login_lost_btn"),i("#lost_login_btn").onWrap("click",(function(){P(p,f),O(g,u),o.setFocusOnElement(i("#loginAccountName"))}),"lost_login_btn"),i("#lost_register_btn").onWrap("click",(function(){P(p,A),O(g,d),o.setFocusOnElement(i("#registerAccountName"))}),"lost_register_btn"),i("#register_lost_btn").onWrap("click",(function(){P(A,p),O(d,g),o.setFocusOnElement(i("#lost_email"))}),"register_lost_btn"),U(),w(),R()}function T(){i("#usergroupLoginPopup").onWrap("hidden.bs.modal",(function(){F.validate().resetForm(),F.find("input, select").val("")})),F.onWrap("submit",(function(e){e.preventDefault(),function(){if(F.validate(),F.valid()){for(var e=F.serializeArray(),s={},o=0;o<e.length;o++)void 0!==e[o].name&&void 0!==e[o].value&&(s[e[o].name]=e[o].value);a.loginUserGroup(s.userGroupOwner,s.userGroupName,s.userGroupName+":"+s.accountName,s.password,(function(e){"ok"===e.rc?(i("#menuDeleteUser, #menuGroupPanel").parent().addClass("unavailable"),n.setLogin(e),r.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,n.getUserName()),s.password===s.userGroupName+":"+s.accountName&&(i("#passOld").val(s.password),i("#grOldPassword").hide(),i("#change-user-password").modal("show"))):r.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,n.getUserName())}))}}()})),F.find("input, select").focus((function(e){var s=i(this).parent().next(".hint");F.find(".hint").not(s).slideUp(E),s.slideDown(E)})),i("#lostPasswordUsergroupLogin").onWrap("click",(function(){P(v,_),O(F,I),o.setFocusOnElement(I)})),i("#loginUsergroupLogin").onWrap("click",(function(){P(_,v),O(I,F),o.setFocusOnElement(i("#usergroupLoginOwner"))})),F.removeData("validator"),i.validator.addMethod("loginRegex",(function(e,s){return this.optional(s)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field contains nonvalid symbols."),F.validate({rules:{usergroupLoginOwner:{required:!0,loginRegex:!0},usergroupLoginUserGroup:{required:!0},usergroupLoginAccount:{required:!0,loginRegex:!0},usergroupLoginPassword:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},messages:{usergroupLoginOwner:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},usergroupLoginUserGroup:{required:t.Msg.VALIDATION_FIELD_REQUIRED},loginAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},loginPassword:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function b(){c.onWrap("submit",(function(e){e.preventDefault(),restPasswordLink=i("#resetPassLink").val(),c.validate(),c.valid()&&(restPasswordLink?a.resetPasswordToServer(restPasswordLink,i("#passNew").val(),(function(e){"ok"===e.rc?(i("#change-user-password").modal("hide"),i("#resetPassLink").val(void 0),r.displayMessage(e.message,"TOAST","")):r.displayInformation(e,"",e.message)})):a.updateUserPasswordToServer(n.getUserAccountName(),i("#passOld").val(),i("#passNew").val(),(function(e){"ok"===e.rc&&i("#change-user-password").modal("hide"),r.displayInformation(e,"",e.message)})))})),i("#showChangeUserPassword").onWrap("click",(function(){i("#change-user-password").modal("show")})),i("#resendActivation").onWrap("click",(function(){a.userSendAccountActivation(n.getUserAccountName(),n.getLanguage(),(function(e){r.displayInformation(e,e.message,e.message)}))})),i("#change-user-password").onWrap("hidden.bs.modal",(function(){c.validate().resetForm(),i("#grOldPassword").show(),i("#passOld").val(""),i("#passNew").val(""),i("#passNewRepeat").val("")})),c.removeData("validator"),c.validate({rules:{passOld:"required",passNew:{required:!0,minlength:6},passNewRepeat:{required:!0,equalTo:"#passNew"}},errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},messages:{passOld:{required:t.Msg.VALIDATION_FIELD_REQUIRED},passNew:{required:t.Msg.VALIDATION_FIELD_REQUIRED,minlength:t.Msg.VALIDATION_PASSWORD_MIN_LENGTH},passNewRepeat:{required:t.Msg.VALIDATION_FIELD_REQUIRED,equalTo:t.Msg.VALIDATION_SECOND_PASSWORD_EQUAL}}})}function S(){i("#loggedIn").text(n.getUserAccountName()),n.isUserLoggedIn()?i("#popup_username").text(t.Msg.POPUP_USERNAME+": "):i("#popup_username").text(t.Msg.POPUP_USERNAME_LOGOFF),i("#programName").text(n.getProgramName()),i("#configurationName").text(n.getConfigurationName()),"beginner"===n.getProgramToolboxLevel()?i("#toolbox").text(t.Msg.MENU_BEGINNER):i("#toolbox").text(t.Msg.MENU_EXPERT),i("#show-state-info").modal("show")}s.activateAccount=function(e){a.userActivateAccount(e,(function(e){r.displayInformation(e,e.message,e.message)}))},s.logout=L,s.init=function(){var e=i.Deferred();return i.when(a.clear((function(e){o.response(e)}))).then((function(){l=i("#div-login-forms"),u=i("#login-form"),g=i("#lost-form"),d=i("#register-form"),c=i("#change-user-password-form"),m=i("#single-modal-form"),f=i("#loginLabel"),A=i("#registerInfoLabel"),p=i("#forgotPasswordLabel"),F=i("#loginUsergroupLoginForm"),I=i("#lostPasswordUsergroupLoginArticle"),v=i("#loginUsergroupLoginTitle"),_=i("#lostPasswordUsergroupLoginTitle"),i("#iconDisplayLogin").onWrap("click",(function(){S()}),"icon user click"),M(),T(),b(),e.resolve()})),e.promise()},s.showUserDataForm=function(){a.getUserFromServer(n.getUserAccountName(),(function(e){"ok"===e.rc&&(i("#registerAccountName").val(e.userAccountName),i("#registerUserEmail").val(e.userEmail),i("#registerUserName").val(e.userName),i("#registerUserAge").val(e.isYoungerThen14?1:2))})),d.off("submit"),d.onWrap("submit",(function(e){e.preventDefault(),n.isUserMemberOfUserGroup()?i("#login-user").modal("hide"):(d.validate(),d.valid()&&a.updateUserToServer(n.getUserAccountName(),i("#registerUserName").val(),i("#registerUserEmail").val(),i("#registerUserAge").val(),n.getLanguage(),(function(e){"ok"===e.rc&&a.getUserFromServer((function(e){"ok"===e.rc&&n.setLogin(e)})),r.displayInformation(e,e.message,e.message)})))})),i("#registerUser").text("OK"),i("#registerAccountName").prop("disabled",!0),i("#userInfoLabel").removeClass("hidden"),i("#loginLabel").addClass("hidden"),i("#registerInfoLabel").addClass("hidden"),i("#forgotPasswordLabel").addClass("hidden"),i("#fgRegisterPass").hide(),i("#fgRegisterPassConfirm").hide(),i("#register_login_btn").hide(),i("#showChangeUserPassword").removeClass("hidden"),n.isPublicServerVersion()&&i("#resendActivation").removeClass("hidden"),i("#register_lost_btn").hide(),u.hide(),d.show(),n.isUserMemberOfUserGroup()?i("#change-user-password").modal("show"):i("#login-user").modal("show")},s.showLoginForm=function(){i("#userInfoLabel").addClass("hidden"),i("#registerInfoLabel").addClass("hidden"),i("#forgotPasswordLabel").addClass("hidden"),u.show(),g.hide(),d.hide(),i("#login-user").modal("show")},s.showUserGroupLoginForm=function(){i("#lostPasswordUsergroupLoginTitle").addClass("hidden"),F.show(),I.hide(),i("#usergroupLoginPopup").modal("show")},s.showDeleteUserModal=function(){o.showSingleModal((function(){i("#singleModalInput").attr("type","password"),i("#single-modal h5").text(t.Msg.MENU_DELETE_USER),i("#single-modal label").text(t.Msg.POPUP_PASSWORD),i("#single-modal span").removeClass("typcn-pencil"),i("#single-modal span").addClass("typcn-lock-closed")}),N,(function(){i("#single-modal span").addClass("typcn-pencil"),i("#single-modal span").removeClass("typcn-lock-closed")}),{rules:{singleModalInput:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,s){e.insertBefore(s.parent())},messages:{singleModalInput:{required:jQuery.validator.format(t.Msg.VALIDATION_FIELD_REQUIRED)}}})},s.showUserInfo=S,s.showResetPassword=function(e){a.checkTargetRecovery(e,(function(s){"ok"===s.rc?(i("#passOld").val(e),i("#resetPassLink").val(e),i("#grOldPassword").hide(),i("#change-user-password").modal("show")):(s.rc="error",r.displayInformation(s,"",s.message))}))},s.initValidationMessages=function(){U(),w(),R()}}));
//# sourceMappingURL=user.controller.js.map
//# sourceMappingURL=user.controller.js.map
